function mod(s,t){return(s%t+t)%t}function dist(s,t,i,h){return Math.min(Math.sqrt(Math.pow(i-s,2)+Math.pow(h-t,2)),Math.sqrt(Math.pow(Math.abs(i-s)-CANVAS_WIDTH,2)+Math.pow(h-t,2)),Math.sqrt(Math.pow(i-s,2)+Math.pow(Math.abs(h-t)-CANVAS_HEIGHT,2)),Math.sqrt(Math.pow(Math.abs(i-s)-CANVAS_WIDTH,2)+Math.pow(Math.abs(h-t)-CANVAS_HEIGHT,2)))}function angleDelta(s,t){for(var i=Math.min(t-s,t-2*Math.PI-s,t-(s-2*Math.PI));i<-Math.PI;)i+=2*Math.PI;for(;i>Math.PI;)i-=2*Math.PI;return i}function FishBit(s){this.x=s.x,this.y=s.y,this.r=FISH_BIT_MIN_R+Math.random()*(FISH_BIT_MAX_R-FISH_BIT_MIN_R),this.t=1*Math.random()+.5}function Fish(s,t,i,h){this.x=s,this.y=t,this.v=i,this.a=h,this.aDelta=0,this.bits=[],this.lastAs=[this.a];for(var a=1;a<1+5*Math.random();a++)this.bits.push(new FishBit(this));this.updatePosition()}function circle(s,t,i,h){s.arc(t,i,h,0,2*Math.PI)}function drawBit(s,t,i){s.lineWidth=t.t*(Math.sin(1-2*i*Math.PI)+1)+.5,s.beginPath(),circle(s,t.x,t.y,t.r),s.stroke()}function drawFish(s,t,i){var h;t.bits.forEach(function(h,a){drawBit(s,h,(i*(1/PULSE_SECONDS)*FRAME_MS+a/t.bits.length)%3/3)}),s.lineWidth=1,t.bits.forEach(function(t){if(null!=h){var i=dist(h.x,h.y,t.x,t.y);Math.abs(h.x-t.x)<2*i&&Math.abs(h.y-t.y)<2*i&&(s.beginPath(),s.moveTo(t.x,t.y),s.lineTo(h.x,h.y),s.stroke())}h=t})}function forEachFish(s){Object.keys(fishMap).forEach(function(t){s(fishMap[t])})}function draw(s,t){s.fillStyle="#000",s.fillRect(0,0,s.canvas.width,s.canvas.height),s.strokeStyle="#fff",forEachFish(function(s){forEachFish(function(t){s!==t&&s.respond(t)}),pseudofishes.forEach(function(t){s.respond(t)})}),forEachFish(function(i){i.updatePosition(),drawFish(s,i,t)}),s.strokeStyle="#f0f",pseudofishes.forEach(function(s){s.updatePosition()})}function makeFish(){return new Fish(Math.random()*CANVAS_WIDTH,Math.random()*CANVAS_HEIGHT,FISH_MIN_V+Math.random()*(FISH_MAX_V-FISH_MIN_V),2*Math.random()*Math.PI)}function cyclePseudofish(s){console.log("cycling"),null==s&&(s=makeFish()),pseudofishes.push(s),pseudofishes.splice(0,1)}socket.on("addFish",function(s){console.log("Adding a fish"),fishMap[s]=makeFish()}),socket.on("removeFish",function(s){console.log("Removing a fish"),delete fishMap[s]}),socket.on("setFishes",function(s){console.log("Setting fishes"),s.forEach(function(s){fishMap[s]=makeFish()})}),socket.emit("host");var NUM_FISH=80,NUM_PSEUDOFISH=2,FISH_MAX_V=.5,FISH_MIN_V=.05,FISH_BIT_MAX_R=8,FISH_BIT_MIN_R=3,PULSE_SECONDS=5,FRAME_MS=1/60,CANVAS_WIDTH=800,CANVAS_HEIGHT=800,AVOID_THRESHOLD=50,FOLLOW_THRESHOLD=150,ADJUST_SCALE=.01,MS_BETWEEN_ADD_FISH=100,MS_BETWEEN_ADD_PSEUDOFISH=1e4,MS_BETWEEN_CYCLE_PSEUDOFISH=1e4,fishMap={},pseudofishes=[];Fish.prototype={respond:function(s){var t=dist(this.x,this.y,s.x,s.y);AVOID_THRESHOLD>t&&this.avoid(s,t),FOLLOW_THRESHOLD>t&&this.follow(s,t)},follow:function(s,t){var i=ADJUST_SCALE*(Math.max(0,FOLLOW_THRESHOLD-t)/FOLLOW_THRESHOLD);if(i>0){var h=s.a;this.aDelta+=angleDelta(this.a,h)*i,this.v=this.v*(1-i)+s.v*i}},avoid:function(s,t){var i=ADJUST_SCALE*(Math.max(0,AVOID_THRESHOLD-t)/AVOID_THRESHOLD);if(i>0){var h=Math.atan2(this.y-s.y,this.x-s.x);this.aDelta+=angleDelta(this.a,h)*i}},updatePosition:function(){for(this.aDelta*=.2,this.a=mod(this.a+this.aDelta,2*Math.PI),this.lastAs=[this.a].concat(this.lastAs);this.lastAs.length>this.bits.length;)this.lastAs=this.lastAs.slice(0,-1);this.x=mod(this.x+this.v*Math.cos(this.a),CANVAS_WIDTH),this.y=mod(this.y+this.v*Math.sin(this.a),CANVAS_HEIGHT);var s=0;this.bits.forEach(function(t,i){var h=angleDelta(this.a,this.lastAs[i]),a=mod(this.a+10*h,2*Math.PI);s+=2*t.r,t.x=mod(this.x+-1*s*Math.cos(a),CANVAS_WIDTH),t.y=mod(this.y+-1*s*Math.sin(a),CANVAS_HEIGHT)}.bind(this))}},$(function(){CANVAS_WIDTH=$(window).width(),CANVAS_HEIGHT=$(window).height(),$(document).keydown(function(s){if(console.log(s.which),90===s.which){pseudofishes=[];for(var t=20,i=0;t>i;i++)pseudofishes.push(new Fish(.33*CANVAS_WIDTH,CANVAS_HEIGHT*(i/t-1),FISH_MAX_V,-.5*Math.PI)),pseudofishes.push(new Fish(.67*CANVAS_WIDTH,CANVAS_HEIGHT*(i/t-1),FISH_MAX_V,.5*Math.PI))}else if(38===s.which){pseudofishes=[];for(var i=0;NUM_PSEUDOFISH>i;i++)pseudofishes.push(new Fish(CANVAS_WIDTH*((i+1)/(NUM_PSEUDOFISH+1)),CANVAS_HEIGHT,FISH_MAX_V,-.5*Math.PI))}else if(40===s.which){pseudofishes=[];for(var i=0;NUM_PSEUDOFISH>i;i++)pseudofishes.push(new Fish(CANVAS_WIDTH*((i+1)/(NUM_PSEUDOFISH+1)),CANVAS_HEIGHT,FISH_MAX_V,.5*Math.PI))}else if(37===s.which){pseudofishes=[];for(var i=0;NUM_PSEUDOFISH>i;i++)pseudofishes.push(new Fish(CANVAS_WIDTH,CANVAS_HEIGHT*((i+1)/(NUM_PSEUDOFISH+1)),FISH_MAX_V,Math.PI))}else if(39===s.which){pseudofishes=[];for(var i=0;NUM_PSEUDOFISH>i;i++)pseudofishes.push(new Fish(0,CANVAS_HEIGHT*((i+1)/(NUM_PSEUDOFISH+1)),FISH_MAX_V,0))}else cyclePseudofish()});var s=$("#canvas")[0];s.width=CANVAS_WIDTH,s.height=CANVAS_HEIGHT;var t=s.getContext("2d");t.translate(CANVAS_WIDTH/2,CANVAS_HEIGHT/2),t.scale(1.1,1.1),t.translate(-CANVAS_WIDTH/2,-CANVAS_HEIGHT/2);var i=(new Date).getTime(),h=0,a=0;setInterval(function(){var s=(new Date).getTime()-i;pseudofishes.length<NUM_PSEUDOFISH&&s>pseudofishes.length*MS_BETWEEN_ADD_PSEUDOFISH&&pseudofishes.push(makeFish()),s>h*MS_BETWEEN_CYCLE_PSEUDOFISH&&(cyclePseudofish(),h++),a++,draw(t,a)},FRAME_MS)});