function mod(s,t){return(s%t+t)%t}function dist(s,t,h,i){return Math.min(Math.sqrt(Math.pow(h-s,2)+Math.pow(i-t,2)),Math.sqrt(Math.pow(Math.abs(h-s)-CANVAS_WIDTH,2)+Math.pow(i-t,2)),Math.sqrt(Math.pow(h-s,2)+Math.pow(Math.abs(i-t)-CANVAS_HEIGHT,2)),Math.sqrt(Math.pow(Math.abs(h-s)-CANVAS_WIDTH,2)+Math.pow(Math.abs(i-t)-CANVAS_HEIGHT,2)))}function angleDelta(s,t){for(var h=Math.min(t-s,t-2*Math.PI-s,t-(s-2*Math.PI));h<-Math.PI;)h+=2*Math.PI;for(;h>Math.PI;)h-=2*Math.PI;return h}function FishBit(s){this.x=s.x,this.y=s.y,this.r=FISH_BIT_MIN_R+Math.random()*(FISH_BIT_MAX_R-FISH_BIT_MIN_R),this.t=1*Math.random()+.5}function Fish(s,t,h,i){this.x=s,this.y=t,this.v=h,this.a=i,this.aDelta=0,this.bits=[],this.lastAs=[this.a];for(var a=1;a<1+5*Math.random();a++)this.bits.push(new FishBit(this));this.updatePosition()}function circle(s,t,h,i){s.arc(t,h,i,0,2*Math.PI)}function drawBit(s,t,h){s.lineWidth=t.t*(Math.sin(1-2*h*Math.PI)+1)+.5,s.beginPath(),circle(s,t.x,t.y,t.r),s.stroke()}function drawFish(s,t,h){var i;t.bits.forEach(function(i,a){drawBit(s,i,(h*(1/PULSE_SECONDS)*FRAME_MS+a/t.bits.length)%3/3)}),s.lineWidth=1,t.bits.forEach(function(t){if(null!=i){var h=dist(i.x,i.y,t.x,t.y);Math.abs(i.x-t.x)<2*h&&Math.abs(i.y-t.y)<2*h&&(s.beginPath(),s.moveTo(t.x,t.y),s.lineTo(i.x,i.y),s.stroke())}i=t})}function draw(s,t){s.fillStyle="#000",s.fillRect(0,0,s.canvas.width,s.canvas.height),s.strokeStyle="#fff",fishes.forEach(function(s){fishes.forEach(function(t){s!==t&&s.respond(t)}),pseudofishes.forEach(function(t){s.respond(t)})}),fishes.forEach(function(h){h.updatePosition(),drawFish(s,h,t)}),s.strokeStyle="#f0f",pseudofishes.forEach(function(s){s.updatePosition()})}function makeFish(){return new Fish(Math.random()*CANVAS_WIDTH,Math.random()*CANVAS_HEIGHT,FISH_MIN_V+Math.random()*(FISH_MAX_V-FISH_MIN_V),2*Math.random()*Math.PI)}function makeFishes(s){for(var t=[],h=0;s>h;h++)t.push(makeFish());return t}function cyclePseudofish(s){console.log("cycling"),null==s&&(s=makeFish()),pseudofishes.push(s),pseudofishes.splice(0,1)}socket.on("addFish",function(s){fishes.push(makeFish())}),socket.on("setFishes",function(s){console.log("ay!"),fishes=s.map(makeFish)}),socket.emit("host");var NUM_FISH=80,NUM_PSEUDOFISH=2,FISH_MAX_V=.5,FISH_MIN_V=.05,FISH_BIT_MAX_R=8,FISH_BIT_MIN_R=3,PULSE_SECONDS=5,FRAME_MS=1/60,CANVAS_WIDTH=800,CANVAS_HEIGHT=800,AVOID_THRESHOLD=50,FOLLOW_THRESHOLD=150,ADJUST_SCALE=.01,MS_BETWEEN_ADD_FISH=100,MS_BETWEEN_ADD_PSEUDOFISH=1e4,MS_BETWEEN_CYCLE_PSEUDOFISH=1e4,fishes=[],pseudofishes=[];Fish.prototype={respond:function(s){var t=dist(this.x,this.y,s.x,s.y);AVOID_THRESHOLD>t&&this.avoid(s,t),FOLLOW_THRESHOLD>t&&this.follow(s,t)},follow:function(s,t){var h=ADJUST_SCALE*(Math.max(0,FOLLOW_THRESHOLD-t)/FOLLOW_THRESHOLD);if(h>0){var i=s.a;this.aDelta+=angleDelta(this.a,i)*h,this.v=this.v*(1-h)+s.v*h}},avoid:function(s,t){var h=ADJUST_SCALE*(Math.max(0,AVOID_THRESHOLD-t)/AVOID_THRESHOLD);if(h>0){var i=Math.atan2(this.y-s.y,this.x-s.x);this.aDelta+=angleDelta(this.a,i)*h}},updatePosition:function(){for(this.aDelta*=.2,this.a=mod(this.a+this.aDelta,2*Math.PI),this.lastAs=[this.a].concat(this.lastAs);this.lastAs.length>this.bits.length;)this.lastAs=this.lastAs.slice(0,-1);this.x=mod(this.x+this.v*Math.cos(this.a),CANVAS_WIDTH),this.y=mod(this.y+this.v*Math.sin(this.a),CANVAS_HEIGHT);var s=0;this.bits.forEach(function(t,h){var i=angleDelta(this.a,this.lastAs[h]),a=mod(this.a+10*i,2*Math.PI);s+=2*t.r,t.x=mod(this.x+-1*s*Math.cos(a),CANVAS_WIDTH),t.y=mod(this.y+-1*s*Math.sin(a),CANVAS_HEIGHT)}.bind(this))}},$(function(){CANVAS_WIDTH=$(window).width(),CANVAS_HEIGHT=$(window).height(),$(document).keydown(function(s){if(console.log(s.which),90===s.which){pseudofishes=[];for(var t=20,h=0;t>h;h++)pseudofishes.push(new Fish(.33*CANVAS_WIDTH,CANVAS_HEIGHT*(h/t-1),FISH_MAX_V,-.5*Math.PI)),pseudofishes.push(new Fish(.67*CANVAS_WIDTH,CANVAS_HEIGHT*(h/t-1),FISH_MAX_V,.5*Math.PI))}else if(38===s.which){pseudofishes=[];for(var h=0;NUM_PSEUDOFISH>h;h++)pseudofishes.push(new Fish(CANVAS_WIDTH*((h+1)/(NUM_PSEUDOFISH+1)),CANVAS_HEIGHT,FISH_MAX_V,-.5*Math.PI))}else if(40===s.which){pseudofishes=[];for(var h=0;NUM_PSEUDOFISH>h;h++)pseudofishes.push(new Fish(CANVAS_WIDTH*((h+1)/(NUM_PSEUDOFISH+1)),CANVAS_HEIGHT,FISH_MAX_V,.5*Math.PI))}else if(37===s.which){pseudofishes=[];for(var h=0;NUM_PSEUDOFISH>h;h++)pseudofishes.push(new Fish(CANVAS_WIDTH,CANVAS_HEIGHT*((h+1)/(NUM_PSEUDOFISH+1)),FISH_MAX_V,Math.PI))}else if(39===s.which){pseudofishes=[];for(var h=0;NUM_PSEUDOFISH>h;h++)pseudofishes.push(new Fish(0,CANVAS_HEIGHT*((h+1)/(NUM_PSEUDOFISH+1)),FISH_MAX_V,0))}else cyclePseudofish()});var s=$("#canvas")[0];s.width=CANVAS_WIDTH,s.height=CANVAS_HEIGHT;var t=s.getContext("2d");t.translate(CANVAS_WIDTH/2,CANVAS_HEIGHT/2),t.scale(1.1,1.1),t.translate(-CANVAS_WIDTH/2,-CANVAS_HEIGHT/2);var h=(new Date).getTime(),i=0,a=0;setInterval(function(){var s=(new Date).getTime()-h;pseudofishes.length<NUM_PSEUDOFISH&&s>pseudofishes.length*MS_BETWEEN_ADD_PSEUDOFISH&&pseudofishes.push(makeFish()),s>i*MS_BETWEEN_CYCLE_PSEUDOFISH&&(cyclePseudofish(),i++),a++,draw(t,a)},FRAME_MS)});