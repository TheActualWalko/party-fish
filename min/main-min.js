function mod(t,s){return(t%s+s)%s}function dist(t,s,i,a){return Math.min(Math.sqrt(Math.pow(i-t,2)+Math.pow(a-s,2)),Math.sqrt(Math.pow(Math.abs(i-t)-CANVAS_WIDTH,2)+Math.pow(a-s,2)),Math.sqrt(Math.pow(i-t,2)+Math.pow(Math.abs(a-s)-CANVAS_HEIGHT,2)),Math.sqrt(Math.pow(Math.abs(i-t)-CANVAS_WIDTH,2)+Math.pow(Math.abs(a-s)-CANVAS_HEIGHT,2)))}function angleDelta(t,s){for(var i=Math.min(s-t,s-2*Math.PI-t,s-(t-2*Math.PI));i<-Math.PI;)i+=2*Math.PI;for(;i>Math.PI;)i-=2*Math.PI;return i}function FishBit(t){this.x=t.x,this.y=t.y,this.r=FISH_BIT_MIN_R+Math.random()*(FISH_BIT_MAX_R-FISH_BIT_MIN_R),this.t=1*Math.random()+.5}function Fish(t,s,i,a){this.x=t,this.y=s,this.v=i,this.a=a,this.aDelta=0,this.bits=[],this.lastAs=[this.a];for(var h=1;h<1+5*Math.random();h++)this.bits.push(new FishBit(this));this.updatePosition()}function circle(t,s,i,a){t.arc(s,i,a,0,2*Math.PI)}function drawBit(t,s,i){t.lineWidth=s.t*(Math.sin(1-2*i*Math.PI)+1)+.5,t.beginPath(),circle(t,s.x,s.y,s.r),t.stroke()}function drawFish(t,s,i){var a;s.bits.forEach(function(a,h){drawBit(t,a,(.5*i*FRAME_TIME+h/s.bits.length)%3/3)}),t.lineWidth=1,s.bits.forEach(function(s){if(null!=a){var i=dist(a.x,a.y,s.x,s.y);Math.abs(a.x-s.x)<2*i&&Math.abs(a.y-s.y)<2*i&&(t.beginPath(),t.moveTo(s.x,s.y),t.lineTo(a.x,a.y),t.stroke())}a=s})}function draw(t,s){t.fillStyle="#000",t.fillRect(0,0,t.canvas.width,t.canvas.height),t.strokeStyle="#fff",fishes.forEach(function(t){fishes.forEach(function(s){t!==s&&t.respond(s)}),pseudofishes.forEach(function(s){t.respond(s)})}),fishes.forEach(function(i){i.updatePosition(),drawFish(t,i,s)}),t.strokeStyle="#f0f",pseudofishes.forEach(function(t){t.updatePosition()})}function makeFish(){return new Fish(Math.random()*CANVAS_WIDTH,Math.random()*CANVAS_HEIGHT,FISH_MIN_V+Math.random()*(FISH_MAX_V-FISH_MIN_V),2*Math.random()*Math.PI)}function makeFishes(t){for(var s=[],i=0;t>i;i++)s.push(makeFish());return s}function cyclePseudofish(){console.log("cycling"),pseudofishes.push(makeFish()),pseudofishes.splice(0,1)}var NUM_FISH=80,NUM_PSEUDOFISH=2,FISH_MAX_V=.5,FISH_MIN_V=.05,FISH_BIT_MAX_R=8,FISH_BIT_MIN_R=3,FRAME_TIME=1/60,CANVAS_WIDTH=800,CANVAS_HEIGHT=800,AVOID_THRESHOLD=50,FOLLOW_THRESHOLD=150,ADJUST_SCALE=.01,MS_BETWEEN_ADD_FISH=100,MS_BETWEEN_ADD_PSEUDOFISH=1e4,MS_BETWEEN_CYCLE_PSEUDOFISH=1e4,fishes=[],pseudofishes=[];Fish.prototype={respond:function(t){var s=dist(this.x,this.y,t.x,t.y);AVOID_THRESHOLD>s&&this.avoid(t,s),FOLLOW_THRESHOLD>s&&this.follow(t,s)},follow:function(t,s){var i=ADJUST_SCALE*(Math.max(0,FOLLOW_THRESHOLD-s)/FOLLOW_THRESHOLD);if(i>0){var a=t.a;this.aDelta+=angleDelta(this.a,a)*i,this.v=this.v*(1-i)+t.v*i}},avoid:function(t,s){var i=ADJUST_SCALE*(Math.max(0,AVOID_THRESHOLD-s)/AVOID_THRESHOLD);if(i>0){var a=Math.atan2(this.y-t.y,this.x-t.x);this.aDelta+=angleDelta(this.a,a)*i}},updatePosition:function(){for(this.aDelta*=.2,this.a=mod(this.a+this.aDelta,2*Math.PI),this.lastAs=[this.a].concat(this.lastAs);this.lastAs.length>this.bits.length;)this.lastAs=this.lastAs.slice(0,-1);this.x=mod(this.x+this.v*Math.cos(this.a),CANVAS_WIDTH),this.y=mod(this.y+this.v*Math.sin(this.a),CANVAS_HEIGHT);var t=0;this.bits.forEach(function(s,i){var a=angleDelta(this.a,this.lastAs[i]),h=mod(this.a+10*a,2*Math.PI);t+=2*s.r,s.x=mod(this.x+-1*t*Math.cos(h),CANVAS_WIDTH),s.y=mod(this.y+-1*t*Math.sin(h),CANVAS_HEIGHT)}.bind(this))}},$(function(){$(document).keydown(function(t){cyclePseudofish()});var t=$("#canvas")[0];t.width=CANVAS_WIDTH,t.height=CANVAS_HEIGHT;var s=t.getContext("2d");s.translate(CANVAS_WIDTH/2,CANVAS_HEIGHT/2),s.scale(1.1,1.1),s.translate(-CANVAS_WIDTH/2,-CANVAS_HEIGHT/2);var i=(new Date).getTime(),a=0,h=0;setInterval(function(){var t=(new Date).getTime()-i;fishes.length<NUM_FISH&&t>fishes.length*MS_BETWEEN_ADD_FISH&&fishes.push(makeFish()),pseudofishes.length<NUM_PSEUDOFISH&&t>pseudofishes.length*MS_BETWEEN_ADD_PSEUDOFISH&&pseudofishes.push(makeFish()),t>a*MS_BETWEEN_CYCLE_PSEUDOFISH&&(cyclePseudofish(),a++),h++,draw(s,h)},FRAME_TIME)});